#!/bin/bash

set -ue

IDENT=${IDENT:-"perlbot-tmp"}
echo ident: $IDENT
GITBRANCH=${GITBRANCH:-"blead"}

PERLBREWOPTS=${PERLBREWOPTS:-"--verbose"}
# Remove old blead tarball.  full clean might lose data we want to keep for now
#rm -f $PERLBREW_ROOT/dists/blead.tar.gz
echo Uninstalling any previous perl as $IDENT
perlbrew uninstall $IDENT || echo "No perl found"
#ls ~/perl5/perlbrew/dists

cd /home/ryan/workspace/perl/
make clean || echo already clean
rm -f /home/ryan/workspace/perl/dist/Time-HiRes/xdefine # clean up xdefine, not sure why it isn't done already, maybe from failed builds before
git reset --hard HEAD
git clean -fd
git checkout $GITBRANCH
git fetch --all
git pull --no-edit || echo NOT ON BRANCH
git stash apply

perlbrew install /home/ryan/workspace/perl --as $IDENT -Dccflags="-fpie -fPIC -march=native -fstack-protector-all -pie -D_FORTIFY_SOURCE=2" -Dldflags="-Wl,-z,now -Wl,-zrelro" $PERLBREWOPTS
